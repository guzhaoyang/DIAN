using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.IO;
using System.Drawing;
using System.Drawing.Imaging;

namespace Dian.Web.Utility
{
    public class ImageHelper
    {
        public Image ResourceImage { get; set; }
        public string ErrMessage { get; set; }

        /// <summary>
        /// 类的构造函数
        /// </summary>
        /// <param name="ImageFileName">图片文件的全路径名称</param>
        public ImageHelper(string ImageFileName)
        {
            ResourceImage = Image.FromFile(ImageFileName);
        }

        public bool ThumbnailCallback()
        {
            return false;
        }

        ///// <summary>
        ///// 生成缩略图重载方法1，返回缩略图的Image对象
        ///// </summary>
        ///// <param name="Width">缩略图的宽度</param>
        ///// <param name="Height">缩略图的高度</param>
        ///// <returns>缩略图的Image对象</returns>
        //public Image GetReducedImage(int Width, int Height)
        //{
        //    try
        //    {
        //        Image ReducedImage;

        //        Image.GetThumbnailImageAbort callb = new Image.GetThumbnailImageAbort(ThumbnailCallback);

        //        ReducedImage = ResourceImage.GetThumbnailImage(Width, Height, callb, IntPtr.Zero);

        //        return ReducedImage;
        //    }
        //    catch (Exception e)
        //    {
        //        ErrMessage = e.Message;
        //        return null;
        //    }
        //}

        ///// <summary>
        ///// 生成缩略图重载方法2，将缩略图文件保存到指定的路径
        ///// </summary>
        ///// <param name="Width">缩略图的宽度</param>
        ///// <param name="Height">缩略图的高度</param>
        ///// <param name="targetFilePath">缩略图保存的全文件名，(带路径)，参数格式：D:\Images\filename.jpg</param>
        ///// <returns>成功返回true，否则返回false</returns>
        //public bool GetReducedImage(int Width, int Height, string targetFilePath)
        //{
        //    try
        //    {
        //        Image ReducedImage;

        //        Image.GetThumbnailImageAbort callb = new Image.GetThumbnailImageAbort(ThumbnailCallback);

        //        ReducedImage = ResourceImage.GetThumbnailImage(Width, Height, callb, IntPtr.Zero);
        //        ReducedImage.Save(@targetFilePath, ImageFormat.Jpeg);

        //        ReducedImage.Dispose();

        //        return true;
        //    }
        //    catch (Exception e)
        //    {
        //        ErrMessage = e.Message;
        //        return false;
        //    }
        //}

        ///// <summary>
        ///// 生成缩略图重载方法3，返回缩略图的Image对象
        ///// </summary>
        ///// <param name="Percent">缩略图的宽度百分比 如：需要百分之80，就填0.8</param>  
        ///// <returns>缩略图的Image对象</returns>
        //public Image GetReducedImage(double Percent)
        //{
        //    try
        //    {
        //        Image ReducedImage;

        //        Image.GetThumbnailImageAbort callb = new Image.GetThumbnailImageAbort(ThumbnailCallback);

        //        ImageWidth = Convert.ToInt32(ResourceImage.Width * Percent);
        //        ImageHeight = Convert.ToInt32(ResourceImage.Width * Percent);

        //        ReducedImage = ResourceImage.GetThumbnailImage(ImageWidth, ImageHeight, callb, IntPtr.Zero);

        //        return ReducedImage;
        //    }
        //    catch (Exception e)
        //    {
        //        ErrMessage = e.Message;
        //        return null;
        //    }
        //}

        ///// <summary>
        ///// 生成缩略图重载方法4，返回缩略图的Image对象
        ///// </summary>
        ///// <param name="Percent">缩略图的宽度百分比 如：需要百分之80，就填0.8</param>  
        ///// <param name="targetFilePath">缩略图保存的全文件名，(带路径)，参数格式：D:\Images\filename.jpg</param>
        ///// <returns>成功返回true,否则返回false</returns>
        //public bool GetReducedImage(double Percent, string targetFilePath)
        //{
        //    try
        //    {
        //        Image ReducedImage;

        //        Image.GetThumbnailImageAbort callb = new Image.GetThumbnailImageAbort(ThumbnailCallback);

        //        ImageWidth = Convert.ToInt32(ResourceImage.Width * Percent);
        //        ImageHeight = Convert.ToInt32(ResourceImage.Width * Percent);

        //        ReducedImage = ResourceImage.GetThumbnailImage(ImageWidth, ImageHeight, callb, IntPtr.Zero);

        //        ReducedImage.Save(@targetFilePath, ImageFormat.Jpeg);

        //        ReducedImage.Dispose();

        //        return true;
        //    }
        //    catch (Exception e)
        //    {
        //        ErrMessage = e.Message;
        //        return false;
        //    }
        //}

        public void GetReducedImage(double maxSize, string targetFilePath)
        {
            double imageWidth;
            double imageHeight;

            if (ResourceImage.Width > ResourceImage.Height)
            {
                imageWidth = maxSize;
                imageHeight = ResourceImage.Height * (maxSize / ResourceImage.Width);
            }
            else
            {
                imageWidth = ResourceImage.Width * (maxSize / ResourceImage.Height);
                imageHeight = maxSize;
            }

            Image.GetThumbnailImageAbort callb = new Image.GetThumbnailImageAbort(ThumbnailCallback);
            using (Image ReducedImage = ResourceImage.GetThumbnailImage((int)imageWidth, (int)imageHeight, callb, IntPtr.Zero))
            {
                ReducedImage.Save(targetFilePath, ImageFormat.Jpeg);
            }
        }

    }
}